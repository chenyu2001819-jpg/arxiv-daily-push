name: arXiv Daily Paper Push

on:
  # 定时触发：每天 UTC 01:00（北京时间 09:00）
  schedule:
    - cron: '0 1 * * *'
  
  # 手动触发
  workflow_dispatch:
    inputs:
      test_email:
        description: '测试邮件配置'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      debug_mode:
        description: '调试模式（放宽搜索条件）'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# 设置权限，允许写入仓库内容
permissions:
  contents: write

jobs:
  fetch-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Load paper history
      uses: actions/cache@v4
      with:
        path: paper_history.json
        key: paper-history-${{ github.run_id }}
        restore-keys: |
          paper-history-
    
    - name: Debug Secrets
      run: |
        echo "Checking if secrets are set..."
        if [ -n "${{ secrets.EMAIL_ENABLED }}" ]; then
          echo "✓ EMAIL_ENABLED is set: ${{ secrets.EMAIL_ENABLED }}"
        else
          echo "✗ EMAIL_ENABLED is NOT set"
        fi
        if [ -n "${{ secrets.EMAIL_SENDER }}" ]; then
          echo "✓ EMAIL_SENDER is set: ${{ secrets.EMAIL_SENDER }}"
        else
          echo "✗ EMAIL_SENDER is NOT set"
        fi
        if [ -n "${{ secrets.EMAIL_RECEIVERS }}" ]; then
          echo "✓ EMAIL_RECEIVERS is set: ${{ secrets.EMAIL_RECEIVERS }}"
        else
          echo "✗ EMAIL_RECEIVERS is NOT set"
        fi
        echo ""
        echo "调试模式: ${{ github.event.inputs.debug_mode }}"
    
    - name: Test email configuration
      if: github.event.inputs.test_email == 'true'
      env:
        EMAIL_ENABLED: ${{ secrets.EMAIL_ENABLED }}
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVERS: ${{ secrets.EMAIL_RECEIVERS }}
        SMTP_HOST: ${{ secrets.SMTP_HOST }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        USE_SSL: ${{ secrets.USE_SSL }}
        USE_TLS: ${{ secrets.USE_TLS }}
      run: python test_email.py
    
    - name: Run arXiv Agent
      if: github.event.inputs.test_email != 'true'
      env:
        EMAIL_ENABLED: ${{ secrets.EMAIL_ENABLED }}
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVERS: ${{ secrets.EMAIL_RECEIVERS }}
        SMTP_HOST: ${{ secrets.SMTP_HOST }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        USE_SSL: ${{ secrets.USE_SSL }}
        USE_TLS: ${{ secrets.USE_TLS }}
        MAX_PAPERS: ${{ secrets.MAX_PAPERS }}
        DAYS_BACK: ${{ secrets.DAYS_BACK }}
        MIN_SCORE: ${{ github.event.inputs.debug_mode == 'true' && '0.5' || secrets.MIN_SCORE }}
        SORT_BY_CITATIONS: ${{ secrets.SORT_BY_CITATIONS }}
      run: |
        echo "开始运行 arXiv Agent..."
        python arxiv_agent.py 2>&1
        echo "运行完成"
    
    - name: Check generated files
      if: github.event.inputs.test_email != 'true'
      run: |
        echo "检查生成的文件..."
        ls -la daily_papers/ 2>/dev/null || echo "daily_papers 目录不存在"
        ls -la paper_history.json 2>/dev/null || echo "paper_history.json 不存在"
        echo ""
        echo "关键词文件内容:"
        head -20 keywords.txt
    
    - name: Save paper history
      uses: actions/cache@v4
      with:
        path: paper_history.json
        key: paper-history-${{ github.run_id }}
    
    - name: Upload reports
      if: github.event.inputs.test_email != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: daily-papers-${{ github.run_id }}
        path: daily_papers/*.md
        retention-days: 30
        if-no-files-found: warn
    
    - name: Commit paper history
      if: github.event.inputs.test_email != 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add paper_history.json
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update paper history [skip ci]"
          git push https://${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
        fi
      continue-on-error: true
