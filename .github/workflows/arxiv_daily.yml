name: arXiv Daily Paper Push

on:
  # 定时触发：每天 UTC 01:00（北京时间 09:00）
  schedule:
    - cron: '0 1 * * *'
  
  # 手动触发
  workflow_dispatch:
    inputs:
      test_email:
        description: '测试邮件配置'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      core_limit:
        description: '核心关键词选取数量'
        required: false
        default: '30'
        type: string
      extended_limit:
        description: '扩展关键词选取数量'
        required: false
        default: '10'
        type: string

# 设置权限
permissions:
  contents: write

jobs:
  fetch-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Load paper history
      uses: actions/cache@v4
      with:
        path: paper_history.json
        key: paper-history-${{ github.run_id }}
        restore-keys: |
          paper-history-
    
    - name: Show configuration
      run: |
        echo "配置信息："
        echo "  核心关键词数量: ${{ github.event.inputs.core_limit || '30' }}"
        echo "  扩展关键词数量: ${{ github.event.inputs.extended_limit || '10' }}"
        echo "  关键词文件内容:"
        cat keywords.txt | head -50
    
    - name: Test email configuration
      if: github.event.inputs.test_email == 'true'
      env:
        EMAIL_ENABLED: ${{ secrets.EMAIL_ENABLED }}
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVERS: ${{ secrets.EMAIL_RECEIVERS }}
        SMTP_HOST: ${{ secrets.SMTP_HOST }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        USE_SSL: ${{ secrets.USE_SSL }}
        USE_TLS: ${{ secrets.USE_TLS }}
      run: python test_email.py
    
    - name: Run arXiv Agent
      if: github.event.inputs.test_email != 'true'
      env:
        EMAIL_ENABLED: ${{ secrets.EMAIL_ENABLED }}
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVERS: ${{ secrets.EMAIL_RECEIVERS }}
        SMTP_HOST: ${{ secrets.SMTP_HOST }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        USE_SSL: ${{ secrets.USE_SSL }}
        USE_TLS: ${{ secrets.USE_TLS }}
        DAYS_BACK: ${{ secrets.DAYS_BACK }}
        CORE_LIMIT: ${{ github.event.inputs.core_limit }}
        EXTENDED_LIMIT: ${{ github.event.inputs.extended_limit }}
      run: |
        echo "开始运行 arXiv Agent..."
        python arxiv_agent.py 2>&1
        echo "运行完成"
    
    - name: Check generated files
      if: github.event.inputs.test_email != 'true'
      run: |
        echo "检查生成的文件..."
        ls -la daily_papers/ 2>/dev/null || echo "daily_papers 目录不存在"
        echo ""
        echo "报告文件列表:"
        ls -la daily_papers/*.md 2>/dev/null || echo "没有生成报告文件"
    
    - name: Save paper history
      uses: actions/cache@v4
      with:
        path: paper_history.json
        key: paper-history-${{ github.run_id }}
    
    - name: Upload reports
      if: github.event.inputs.test_email != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: daily-papers-${{ github.run_id }}
        path: daily_papers/*.md
        retention-days: 30
        if-no-files-found: warn
    
    - name: Commit paper history
      if: github.event.inputs.test_email != 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add paper_history.json
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update paper history [skip ci]"
          git push https://${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
        fi
      continue-on-error: true
